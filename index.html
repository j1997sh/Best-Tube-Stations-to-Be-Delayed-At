<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Best Tube Station To Be Delayed At</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --blue:#0019a8;
  --red:#da291c;
  --bg:#f3f5fb;
  --card:#fff;
  --line:#e3e6f2;
  --muted:#5f6b85;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:linear-gradient(180deg,#fff,var(--bg));
}
header{
  background:#fff;
  border-bottom:1px solid var(--line);
  padding:14px;
}
h1{margin:0;font-size:18px}
.sub{font-size:13px;color:var(--muted)}

.wrap{
  max-width:1100px;
  margin:auto;
  padding:14px;
  display:grid;
  grid-template-columns:420px 1fr;
  gap:14px;
}
@media(max-width:900px){
  .wrap{grid-template-columns:1fr}
  #map{height:50vh}
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grow{flex:1}

input,button{
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  font-size:14px;
}
button{
  background:linear-gradient(90deg,var(--blue),var(--red));
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.6}

.pill{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#fff;
  font-size:12px;
}
.small{font-size:12px;color:var(--muted)}

#map{
  height:calc(100vh - 120px);
  border-radius:16px;
  border:1px solid var(--line);
}

.pub{
  margin-top:14px;
  padding-top:14px;
  border-top:1px solid var(--line);
}
.pub a{
  text-decoration:none;
  font-size:12px;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid var(--line);
}
.verdict{
  margin-top:12px;
  padding:10px;
  border-radius:12px;
  background:#f7f8fd;
  border:1px dashed var(--line);
}
</style>
</head>

<body>
<header>
  <h1>Best Tube Station To Be Delayed At</h1>
  <div class="sub">Nearest station. Nearest pub. Nearest Spoons. Brutal honesty.</div>
</header>

<div class="wrap">
  <div>
    <div class="card">
      <div class="row">
        <input id="postcode" placeholder="Postcode (optional)" class="grow">
        <button id="go">Go</button>
      </div>

      <div id="chips" class="row" style="margin-top:10px"></div>
      <div id="verdict" class="verdict small"></div>

      <div id="closestPub" class="pub"></div>
      <div id="closestSpoons" class="pub"></div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
/* ---------------- config ---------------- */
const PROXY = url =>
  `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

async function fetchJson(url){
  const r = await fetch(PROXY(url));
  if(!r.ok) throw new Error("Network error");
  return await r.json();
}

/* ---------------- helpers ---------------- */
const R=6371000;
const toRad=x=>x*Math.PI/180;
const dist=(a,b,c,d)=>{
  const dLat=toRad(c-a),dLon=toRad(d-b);
  const x=Math.sin(dLat/2)**2+
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
};
const m=x=>x<1000?`${Math.round(x)} m`:`${(x/1000).toFixed(2)} km`;
const isSpoons=n=>(n||"").toLowerCase().includes("wetherspoon");

/* ---------------- map ---------------- */
const map=L.map("map").setView([51.5074,-0.1278],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const markers=L.layerGroup().addTo(map);

/* ---------------- funny bits ---------------- */
const EXCUSES=[
  "Signal failure. Emotionally unavailable train.",
  "Waiting for a train that spiritually isn‚Äôt coming.",
  "Minor delays due to vibes.",
  "Trespasser on the line (it was probably a fox).",
  "Train cancelled because it sensed weakness."
];
function verdictText(pubDist, hasSpoons){
  if(pubDist < 200) return "üü¢ Yes. Sit down immediately.";
  if(pubDist < 500) return "üü† One pint, then reassess life.";
  if(hasSpoons) return "üü† It‚Äôs a Spoons. You know the rules.";
  return "üî¥ This delay is not pub-worthy.";
}

/* ---------------- main ---------------- */
async function run(){
  markers.clearLayers();
  chips.innerHTML="‚è≥ Working out how bad this is‚Ä¶";
  closestPub.innerHTML="";
  closestSpoons.innerHTML="";
  verdict.innerHTML="";

  let lat, lon;

  const pc=postcode.value.trim();
  if(pc){
    const geo=await fetchJson(`https://api.postcodes.io/postcodes/${pc}`);
    lat=geo.result.latitude;
    lon=geo.result.longitude;
  }else{
    const pos = await new Promise((res,rej)=>
      navigator.geolocation.getCurrentPosition(res,rej)
    );
    lat=pos.coords.latitude;
    lon=pos.coords.longitude;
  }

  const sp=await fetchJson(
    `https://api.tfl.gov.uk/StopPoint?lat=${lat}&lon=${lon}&radius=1200&stopTypes=NaptanMetroStation`
  );
  const st=sp.stopPoints
    .map(s=>({...s,d:dist(lat,lon,s.lat,s.lon)}))
    .sort((a,b)=>a.d-b.d)[0];

  chips.innerHTML="";
  chips.append(
    pill(`üöá ${st.commonName}`)
  );

  const over=await fetchJson(
    `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(`
      [out:json][timeout:10];
      node["amenity"="pub"](around:900,${st.lat},${st.lon});
      out tags center 20;
    `)}`
  );

  const pubs=over.elements.map(e=>{
    if(!e.lat||!e.lon) return null;
    return{
      name:e.tags?.name||"Unnamed pub",
      lat:e.lat,lon:e.lon,
      d:dist(st.lat,st.lon,e.lat,e.lon)
    };
  }).filter(Boolean).sort((a,b)=>a.d-b.d);

  const pub=pubs[0];
  const spoons=pubs.find(p=>isSpoons(p.name));

  markers.addLayer(L.marker([lat,lon]).bindPopup("You"));
  markers.addLayer(L.marker([st.lat,st.lon]).bindPopup(st.commonName));

  if(pub){
    markers.addLayer(L.marker([pub.lat,pub.lon]).bindPopup(pub.name));
    closestPub.innerHTML=renderPub("Closest pub",pub,st,lat,lon);
  }
  if(spoons){
    markers.addLayer(L.marker([spoons.lat,spoons.lon]).bindPopup(spoons.name));
    closestSpoons.innerHTML=renderPub("Closest Wetherspoons",spoons,st,lat,lon);
  }

  verdict.innerHTML=`
    <b>${verdictText(pub?.d||9999,!!spoons)}</b><br>
    ${EXCUSES[Math.floor(Math.random()*EXCUSES.length)]}
  `;

  map.fitBounds(markers.getBounds().pad(0.3));
}

function renderPub(title,pub,st,lat,lon){
  const dirS=`https://www.google.com/maps/dir/?api=1&origin=${st.lat},${st.lon}&destination=${pub.lat},${pub.lon}&travelmode=walking`;
  const dirU=`https://www.google.com/maps/dir/?api=1&origin=${lat},${lon}&destination=${pub.lat},${pub.lon}&travelmode=walking`;
  const open=`https://www.google.com/maps/search/?api=1&query=${pub.lat},${pub.lon}`;
  return `
    <b>${title}</b><br>
    <b>${pub.name}</b><br>
    <span class="small">${m(pub.d)} from station</span>
    <div class="row" style="margin-top:6px">
      <a href="${dirS}" target="_blank">üö∂ Station ‚Üí Pub</a>
      <a href="${dirU}" target="_blank">üö∂ You ‚Üí Pub</a>
      <a href="${open}" target="_blank">üìç Maps</a>
    </div>
  `;
}
function pill(t){
  const s=document.createElement("span");
  s.className="pill";
  s.textContent=t;
  return s;
}

go.onclick=run;
postcode.addEventListener("keydown",e=>e.key==="Enter"&&run());
</script>
</body>
</html>
