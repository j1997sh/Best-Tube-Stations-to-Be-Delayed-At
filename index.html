<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Best Tube Station To Be Delayed At</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --blue:#0019a8;
  --red:#da291c;
  --bg:#f3f5fb;
  --card:#fff;
  --line:#e3e6f2;
  --muted:#5f6b85;
  --ok:#177245;
  --warn:#b55a00;
  --bad:#b00020;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:linear-gradient(180deg,#fff,var(--bg));
}
header{
  background:#fff;
  border-bottom:1px solid var(--line);
  padding:14px;
}
h1{margin:0;font-size:18px}
.sub{font-size:13px;color:var(--muted)}

.wrap{
  max-width:1200px;
  margin:auto;
  padding:14px;
  display:grid;
  grid-template-columns:420px 1fr;
  gap:14px;
}
@media(max-width:900px){
  .wrap{grid-template-columns:1fr}
  #map{height:50vh}
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grow{flex:1}
input,button{
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  font-size:14px;
}
button{
  background:linear-gradient(90deg,var(--blue),var(--red));
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.6}

.pill{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#fff;
  font-size:12px;
}
.small{font-size:12px;color:var(--muted)}

#map{
  height:calc(100vh - 120px);
  border-radius:16px;
  border:1px solid var(--line);
}

.pub{
  border-top:1px solid var(--line);
  padding-top:10px;
  margin-top:10px;
}
.pub a{
  text-decoration:none;
  font-size:12px;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid var(--line);
}

.statusList{
  margin-top:14px;
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}
.statusRow{
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.statusRow:last-child{border-bottom:0}
.badge{
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
}
.sevOK{background:#e7f6ee;color:var(--ok)}
.sevWarn{background:#fff2e0;color:var(--warn)}
.sevBad{background:#fde7ea;color:var(--bad)}
</style>
</head>

<body>
<header>
  <h1>Best Tube Station To Be Delayed At</h1>
  <div class="sub">Tube delays + best pubs nearby</div>
</header>

<div class="wrap">
  <div>
    <div class="card">
      <div class="row">
        <input id="postcode" placeholder="Postcode e.g. SW1A 1AA" class="grow">
        <button id="go">Go</button>
      </div>
      <div id="chips" class="row" style="margin-top:10px"></div>
      <div id="info" class="small" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <b>Top 5 pubs</b>
      <div id="pubList"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Tube line status</b>
        <button id="refreshStatus" style="padding:8px 10px;font-size:12px">Refresh</button>
      </div>
      <div id="statusList" class="statusList"></div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
/* ---------- helpers ---------- */
const PROXIES=[
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://corsproxy.io/?${encodeURIComponent(u)}`
];
async function fetchJson(url){
  for(const p of [u=>u,...PROXIES]){
    try{const r=await fetch(p(url));if(r.ok)return await r.json();}catch{}
  }
  throw new Error("Fetch failed");
}
const R=6371000;
const toRad=x=>x*Math.PI/180;
const dist=(a,b,c,d)=>{
  const dLat=toRad(c-a),dLon=toRad(d-b);
  const x=Math.sin(dLat/2)**2+
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
};
const m=x=>x<1000?`${Math.round(x)}m`:`${(x/1000).toFixed(2)}km`;
const isSpoons=n=>(n||"").toLowerCase().includes("wetherspoon");

/* ---------- map ---------- */
const map=L.map("map").setView([51.5074,-0.1278],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const markers=L.layerGroup().addTo(map);

/* ---------- tube status ---------- */
function sev(desc=""){
  const d=desc.toLowerCase();
  if(d.includes("good"))return"sevOK";
  if(d.includes("minor")||d.includes("part"))return"sevWarn";
  return"sevBad";
}
async function loadTubeStatus(){
  const host=document.getElementById("statusList");
  host.innerHTML="";
  try{
    const data=await fetchJson("https://api.tfl.gov.uk/Line/Mode/tube/Status");
    data.forEach(l=>{
      const s=l.lineStatuses?.[0];
      const d=s?.statusSeverityDescription||"Unknown";
      host.insertAdjacentHTML("beforeend",`
        <div class="statusRow">
          <div>
            <b>${l.name}</b>
            <div class="small">${s?.reason||""}</div>
          </div>
          <div class="badge ${sev(d)}">${d}</div>
        </div>
      `);
    });
  }catch{
    host.innerHTML=`<div class="statusRow"><b>Error loading status</b></div>`;
  }
}

/* ---------- main ---------- */
async function run(){
  markers.clearLayers();
  pubList.innerHTML="";
  chips.innerHTML="";
  info.innerHTML="";

  const pc=postcode.value.trim();
  if(!pc) return;

  const geo=await fetchJson(`https://api.postcodes.io/postcodes/${pc}`);
  const {latitude,longitude}=geo.result;

  const sp=await fetchJson(
    `https://api.tfl.gov.uk/StopPoint?lat=${latitude}&lon=${longitude}&radius=1500&stopTypes=NaptanMetroStation`
  );
  const st=sp.stopPoints
    .map(s=>({...s,d:dist(latitude,longitude,s.lat,s.lon)}))
    .sort((a,b)=>a.d-b.d)[0];

  const over=await fetchJson(
    `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(`
      [out:json];
      (node["amenity"="pub"](around:1500,${st.lat},${st.lon});
       way["amenity"="pub"](around:1500,${st.lat},${st.lon}););
      out center tags;
    `)}`
  );

  const pubs=over.elements.map(e=>{
    const lat=e.lat??e.center?.lat;
    const lon=e.lon??e.center?.lon;
    if(!lat||!lon) return null;
    return{
      name:e.tags?.name||"Unnamed pub",
      opening:e.tags?.opening_hours,
      lat,lon,
      d:dist(st.lat,st.lon,lat,lon)
    };
  }).filter(Boolean).sort((a,b)=>a.d-b.d);

  const top5=pubs.slice(0,5);
  const density=pubs.filter(p=>p.d<=800).length;
  const spoons=pubs.find(p=>isSpoons(p.name));

  chips.append(
    chip(`üöá ${st.commonName}`),
    chip(`üç∫ ${density} pubs within 10 min`),
    spoons?chip(`üçª Spoons ${m(spoons.d)}`):""
  );

  info.innerHTML=`Station distance: ${m(st.d)}`;

  markers.addLayer(L.marker([latitude,longitude]).bindPopup("Postcode"));
  markers.addLayer(L.marker([st.lat,st.lon]).bindPopup(st.commonName));

  top5.forEach((p,i)=>{
    markers.addLayer(L.marker([p.lat,p.lon]).bindPopup(p.name));
    const dirS=`https://www.google.com/maps/dir/?api=1&origin=${st.lat},${st.lon}&destination=${p.lat},${p.lon}&travelmode=walking`;
    const dirU=`https://www.google.com/maps/dir/?api=1&origin=${latitude},${longitude}&destination=${p.lat},${p.lon}&travelmode=walking`;
    const open=`https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}`;
    pubList.insertAdjacentHTML("beforeend",`
      <div class="pub">
        <b>${i+1}. ${p.name}</b><br>
        <span class="small">${m(p.d)} from station</span>
        ${p.opening?`<div class="small">üïí ${p.opening}</div>`:""}
        <div class="row" style="margin-top:6px">
          <a href="${dirS}" target="_blank">üö∂ Station ‚Üí Pub</a>
          <a href="${dirU}" target="_blank">üö∂ Postcode ‚Üí Pub</a>
          <a href="${open}" target="_blank">üìç Maps</a>
        </div>
      </div>
    `);
  });

  map.fitBounds(markers.getBounds().pad(0.25));
}

/* ---------- wiring ---------- */
go.onclick=run;
postcode.addEventListener("keydown",e=>e.key==="Enter"&&run());
refreshStatus.onclick=loadTubeStatus;
loadTubeStatus();

function chip(t){
  const s=document.createElement("span");
  s.className="pill";
  s.textContent=t;
  return s;
}
</script>
</body>
</html>
