<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Best Tube Station To Be Delayed At</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --tfl-blue:#0019a8;
  --tfl-red:#da291c;
  --ink:#0b0f1a;
  --bg:#f3f5fb;
  --card:#ffffff;
  --line:#e6e8f2;
  --muted:#5a647a;
  --shadow:0 10px 30px rgba(0,0,0,.06);
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 15% -10%, rgba(0,25,168,.12), transparent 60%),
    radial-gradient(900px 500px at 85% 0%, rgba(218,41,28,.12), transparent 60%),
    linear-gradient(180deg,#fff 0%,var(--bg) 55%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--ink);
}
header{
  position:sticky;top:0;z-index:10;
  background:rgba(255,255,255,.9);
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--line);
}
.top{
  max-width:1200px;margin:auto;padding:14px 16px;
  display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;
}
.brand{display:flex;gap:14px;align-items:center}
.roundel{
  width:54px;height:54px;border-radius:999px;background:var(--tfl-red);position:relative;
}
.roundel:before{
  content:"";position:absolute;inset:10px;background:#fff;border-radius:999px;
}
.roundel:after{
  content:"";position:absolute;left:9px;right:9px;top:50%;height:12px;
  transform:translateY(-50%);background:var(--tfl-blue);
}
h1{margin:0;font-size:18px}
.sub{margin:4px 0 0;color:var(--muted);font-size:13px}

.shell{
  max-width:1200px;margin:auto;padding:14px 16px;
  display:grid;grid-template-columns:420px 1fr;gap:14px;
}
@media(max-width:980px){
  .shell{grid-template-columns:1fr}
  #map{height:52vh!important}
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.cardHead{padding:14px;border-bottom:1px solid var(--line)}
.cardBody{padding:14px}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1}

input{
  width:100%;padding:12px;border-radius:14px;border:1px solid #d6daea;
  font-size:15px;
}
button{
  padding:12px 14px;border-radius:14px;border:none;
  background:linear-gradient(90deg,var(--tfl-blue),var(--tfl-red));
  color:#fff;font-weight:700;cursor:pointer;
}
button:disabled{opacity:.6}

.pill{
  padding:6px 10px;border-radius:999px;border:1px solid var(--line);
  background:#fff;font-size:12px;color:var(--muted);
}

#map{
  height:calc(100vh - 120px);
  border-radius:var(--radius);
  border:1px solid var(--line);
}

.pub{
  border-top:1px solid var(--line);
  padding-top:10px;margin-top:10px;
}
.pub a{
  text-decoration:none;font-size:12px;padding:6px 8px;
  border-radius:8px;border:1px solid var(--line);
}
.small{font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="roundel"></div>
      <div>
        <h1>Best Tube Station To Be Delayed At</h1>
        <div class="sub">Nearest station, best pubs, full Tube chaos.</div>
      </div>
    </div>
  </div>
</header>

<main class="shell">
<section class="card">
  <div class="cardHead">
    <div class="row">
      <div class="grow">
        <input id="postcode" placeholder="Postcode e.g. SW1A 1AA">
      </div>
      <button id="go">Find my delay pub</button>
    </div>
  </div>

  <div class="cardBody">
    <div id="chips" class="row"></div>
    <div id="info" class="small" style="margin-top:10px"></div>

    <h3 style="margin-top:18px">Top 5 pubs</h3>
    <div id="pubList"></div>
  </div>
</section>

<section id="map"></section>
</main>

<script>
const PROXIES=[
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://corsproxy.io/?${encodeURIComponent(u)}`
];

async function fetchJson(url){
  for(const p of [u=>u,...PROXIES]){
    try{
      const r=await fetch(p(url));
      if(r.ok) return await r.json();
    }catch{}
  }
  throw new Error("Network error");
}

const map=L.map("map").setView([51.5074,-0.1278],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const markers=L.layerGroup().addTo(map);

const R=6371000;
const dist=(a,b,c,d)=>{
  const toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a),dLon=toRad(d-b);
  const x=Math.sin(dLat/2)**2+
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
};
const m=x=>x<1000?`${Math.round(x)} m`:`${(x/1000).toFixed(2)} km`;
const isSpoons=n=>(n||"").toLowerCase().includes("wetherspoon");

async function run(){
  markers.clearLayers();
  pubList.innerHTML="";
  chips.innerHTML="";
  info.innerHTML="";

  const pc=postcode.value.trim();
  if(!pc) return;

  const geo=await fetchJson(`https://api.postcodes.io/postcodes/${pc}`);
  const {latitude,longitude,postcode:p}=geo.result;

  const sp=await fetchJson(
    `https://api.tfl.gov.uk/StopPoint?lat=${latitude}&lon=${longitude}&radius=1500&stopTypes=NaptanMetroStation`
  );
  const st=sp.stopPoints
    .map(s=>({...s,d:dist(latitude,longitude,s.lat,s.lon)}))
    .sort((a,b)=>a.d-b.d)[0];

  const over=await fetchJson(
    `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(`
      [out:json];
      (node["amenity"="pub"](around:1500,${st.lat},${st.lon});
       way["amenity"="pub"](around:1500,${st.lat},${st.lon}););
      out center tags;
    `)}`
  );

  const pubs=over.elements.map(e=>{
    const lat=e.lat??e.center?.lat;
    const lon=e.lon??e.center?.lon;
    if(!lat||!lon) return null;
    return{
      name:e.tags?.name||"Unnamed pub",
      opening:e.tags?.opening_hours,
      lat,lon,
      d:dist(st.lat,st.lon,lat,lon)
    };
  }).filter(Boolean).sort((a,b)=>a.d-b.d);

  const top5=pubs.slice(0,5);
  const density=pubs.filter(p=>p.d<=800).length;
  const spoons=pubs.find(p=>isSpoons(p.name));

  chips.append(
    chip(`üöá ${st.commonName}`),
    chip(`üç∫ ${density} pubs within 10 min`),
    spoons?chip(`üçª Spoons ${m(spoons.d)}`):""
  );

  info.innerHTML=`Station distance: ${m(st.d)}`;

  markers.addLayer(L.marker([latitude,longitude]).bindPopup("Postcode"));
  markers.addLayer(L.marker([st.lat,st.lon]).bindPopup(st.commonName));

  top5.forEach((p,i)=>{
    markers.addLayer(L.marker([p.lat,p.lon]).bindPopup(p.name));
    const dirS=`https://www.google.com/maps/dir/?api=1&origin=${st.lat},${st.lon}&destination=${p.lat},${p.lon}&travelmode=walking`;
    const dirU=`https://www.google.com/maps/dir/?api=1&origin=${latitude},${longitude}&destination=${p.lat},${p.lon}&travelmode=walking`;
    const open=`https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}`;

    pubList.insertAdjacentHTML("beforeend",`
      <div class="pub">
        <b>${i+1}. ${p.name}</b><br>
        <span class="small">${m(p.d)} from station</span>
        ${p.opening?`<div class="small">üïí ${p.opening}</div>`:""}
        <div class="row" style="margin-top:6px">
          <a href="${dirS}" target="_blank">üö∂ Station ‚Üí Pub</a>
          <a href="${dirU}" target="_blank">üö∂ Postcode ‚Üí Pub</a>
          <a href="${open}" target="_blank">üìç Maps</a>
        </div>
      </div>
    `);
  });

  map.fitBounds(markers.getBounds().pad(0.25));
}

function chip(t){
  const s=document.createElement("span");
  s.className="pill";
  s.textContent=t;
  return s;
}

go.onclick=run;
postcode.addEventListener("keydown",e=>e.key==="Enter"&&run());
</script>
</body>
</html>
